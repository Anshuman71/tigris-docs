### Prerequisites

All you'll need is any computer running macOS or Linux, with
[NodeJS v12](https://nodejs.org/en/blog/release/) or later installed.

### 1. Scaffold the tigris quickstart app

Let's create a directory and run following commands to scaffold a TypeScript
project

```shell
$ mkdir hello-tigris
$ cd hello-tigris
$ npx create-tigris-app
```

This command initializes following file structure in `hello-tigris` directory:

```
.
├── package.json
├── src
│   ├── testScript.ts
│   ├── tigrisClient.ts
│   ├── repository
│   │   └── users.ts
│   └── models
│       └── user.ts
└── tsconfig.json
```

- `package.json` is the node project metadata, and lists
  [@tigrisdata/core](https://www.npmjs.com/package/@tigrisdata/core)
  as one of the dependencies
- `src/testScript.ts` is an empty file we will use to execute queries
  against Tigris database
- `src/tigrisClient.ts` is an already created TypeScript client we will use
  to connect to Tigris DB
- `src/repository/users.ts` is a boilerplate class where we will write some
  queries to perform CRUD operations on a collection
- `src/models/user.ts` is a Tigris data model class used for this exercise
- `tsconfig.json` is the TypeScript project config and won't be relevant for
  this tutorial

Then, install the project dependencies

```shell
$ npm install
```

### 2. Model data in a Tigris collection schema

Tigris uses a declarative approach to database infrastructure and enforces
that all documents stored in collection conform to the collection's schema.
For our convenience, `User` schema definition is pre-populated in our project:

```ts title=src/models/user.ts showLineNumbers
import {
  TigrisCollectionType,
  TigrisDataTypes,
  TigrisSchema,
} from "@tigrisdata/core/dist/types";

export interface User extends TigrisCollectionType {
  userId?: number;
  name: string;
  balance: number;
}

export const userSchema: TigrisSchema<User> = {
  userId: {
    type: TigrisDataTypes.INT32,
    primary_key: {
      order: 1,
      autoGenerate: true,
    },
  },
  name: {
    type: TigrisDataTypes.STRING,
  },
  balance: {
    type: TigrisDataTypes.NUMBER,
  },
};
```

In Tigris, models represent the collections in the underlying database. In
the next section, we will map this `User` model to a collection.

### 3. Initialize Tigris client and setup database

The already included `TigrisClient` in `src/tigrisClient.ts` uses Tigris's
client library to establish a connection to database:

```ts title=src/tigrisClient.ts showLineNumbers
import { DB, Tigris } from "@tigrisdata/core";
import { User, userSchema } from "./models/user";

export class TigrisClient {
  private readonly dbName: string;
  private readonly tigris: Tigris;
  private _db: DB;

  constructor() {
    this.dbName = "hello_tigris";
    this.tigris = new Tigris({
      serverUrl: "localhost:8081",
      insecureChannel: true,
    });
  }

  public get db(): DB {
    return this._db;
  }

  public async setup() {
    await this.initializeTigris();
  }

  public async initializeTigris() {
    // create database (if not exists)
    this._db = await this.tigris.createDatabaseIfNotExists(this.dbName);
    console.log("db: " + this.dbName + " created successfully");

    // register collections schema and wait for it to finish
    await Promise.all([
      this._db.createOrUpdateCollection<User>("users", userSchema),
    ]);
  }

  // drop the users collection
  public dropCollection = async () => {
    const resp = await this._db.dropCollection("users");
    console.log(resp);
  };
}
```

This client also initializes a database named `hello_tigris` and creates a
`users` collection conforming to schema defined in `src/models/user.ts`.

:::info

The example points to Tigris DB instance running in `localhost:8081` and can
be modified as per your environment.

:::

### 4. Explore how to send queries to database

This section is hands-on, we will use the `Users` class in
`src/repository/users.ts` to write some queries to interact with newly
created collection. The class presents following boilerplate template
for us to use:

```ts title=src/repository/users.ts showLineNumbers
import { User } from "../models/user";
import { Collection, DB } from "@tigrisdata/core";

export class Users {
  private readonly users: Collection<User>;

  constructor(db: DB) {
    this.users = db.getCollection<User>("users");
  }

  // TODO: Add CRUD operations here
}
```

We will add create, read, update, delete and search operations to this
collection class in next few sections.

#### 4.1 Create a new `User` document

Let's add following method in `Users` class in `src/repository/users.ts` to
insert a document in collection:

```ts
// .... boilerplate ....

// Insert a user in collection
public createUser = async (user: User) => {
  const createdUser = await this.users.insert(user);
  console.log(createdUser);
}
```

#### 4.2 Read a single document from collection

Finding a `user` is relatively simple using `findOne()` construct

```ts
// .... boilerplate ....

// Get a single user from collection
public getUser = async (userId: number) => {
  const user = await this.users.findOne({
    userId: userId
  });

  if (user !== undefined) {
    console.log(user);
  } else {
    console.log(`No user found matching userId = ${userId}`)
  }
}
```

#### 4.3 Read all `User` documents

Tigris client also provides an easy to use streaming api to read multiple
documents from collection.

```ts
// .... boilerplate ....

// Get all users from collection
public getAllUsers = async () => {
  return new Promise<void>((resolve, reject) =>
    this.users.findAllStream({
      onNext(user: User) {
        console.log(JSON.parse(JSON.stringify(user)));
      },
      onEnd() {
        resolve();
      },
      onError(error: Error) {
        console.log(`Error fetching users ${error}`);
        reject();
      }
    })
  );
}
```

#### 4.4 Update a `User`

All collection APIs, including `update()`, use the same
[filter](typescript/query.mdx#filter) operations to target the query to
selected documents. For example, to update a user balance:

```ts
import {SelectorFilterOperator, UpdateFieldsOperator} from "@tigrisdata/core/dist/types";

// .... boilerplate ....

// Update a user's "balance"
public updateUserBalance = async (userName: string, newBalance: number) => {
  await this.users.update({
    op: SelectorFilterOperator.EQ,
      fields: {
        name: userName
      }
  }, {
    op: UpdateFieldsOperator.SET,
    fields: {
      balance: newBalance
    }
  });
}
```

#### 4.5 Search for `Users`

Tigris offers a realtime search for documents in collection. Searching is by
default enabled for a collection, no explicit setup required. Let's say, we
want find users with name matching **Amy**:

```ts
import {SearchRequest, SearchResult} from "@tigrisdata/core/dist/search/types";

// .... boilerplate ....

// Search for users where name matches "nameLike"
public searchUsers = async (nameLike: string) => {
  const query: SearchRequest<User> = {
    q: nameLike
  };

  return new Promise<void>((resolve, reject) =>
    this.users.search(query, {
      onNext(result: SearchResult<User>) {
        for (let i = 0; i < result.hits.length; i++) {
          console.log(JSON.parse(JSON.stringify(result.hits[i].document)));
        }
      },
      onEnd() {
        resolve();
      },
      onError(error: Error) {
        console.log(`Error searching for users ${error}`);
        reject();
      }
    })
  );
}
```

#### 4.6 Delete a `User`

The `delete()` operation follows same semantics as create/read/update APIs.

```ts
// .... boilerplate ....

// Delete a user by "userId"
public deleteUser = async (userIdToDelete: number) => {
  await this.users.delete({
    userId: userIdToDelete,
  });
}
```

Before moving to next section, let's review what we did here. We used simple
constructs offered by Tigris's client library and added create, read, update,
delete and search capabilities in `Users` class to use **users** collection.

### 5. Use the database and perform some operations

We now have a `TigrisClient` object that instantiates **hello_tigris**
database and **users**
collection for us, and a `Users` class that can perform CRUD operations on
the collection.
Let's add following code to the driver script in `src/testScript.ts` file:

```ts title=src/testScript.ts showLineNumbers
import { TigrisClient } from "./tigrisClient";
import { Users } from "./repository/users";

async function main() {
  const tigris = new TigrisClient();
  await tigris.setup();

  const usersCollection = new Users(tigris.db);

  console.log("\nInserting 3 users");
  await usersCollection.createUser({
    userId: 1,
    name: "Jania McGrory",
    balance: 100,
  });
  await usersCollection.createUser({
    userId: 2,
    name: "Amy Jackson",
    balance: 200,
  });
  await usersCollection.createUser({
    userId: 3,
    name: "Amylia Jones",
    balance: 80,
  });

  console.log("\nRead user with userId = 2");
  await usersCollection.getUser(2);

  console.log("\nReading all users");
  await usersCollection.getAllUsers();

  console.log("\nUpdate balance to 45 for userName = Jania McGrory");
  await usersCollection.updateUserBalance("Jania McGrory", 45);
  console.log("Verify that update has processed");
  await usersCollection.getUser(1);

  console.log("\nFind users with name like 'amy'");
  await usersCollection.searchUsers("amy");

  console.log("\nDelete userId = 3");
  await usersCollection.deleteUser(3);
  console.log("Read all users to verify userId = 3 is deleted");
  await usersCollection.getAllUsers();

  console.log("\nDrop collection");
  await tigris.dropCollection();
}

main().then((r) => console.log("\nQuickstart tutorial completed"));
```

Now execute the above script using **npm**

```shell
npm run test
```

You would see the following output

```shell
db: hello_tigris created successfully
{"title":"users","additionalProperties":false,"type":"object","properties":{"userId":{"type":"integer","format":"int32","autoGenerate":true},"name":{"type":"string"},"balance":{"type":"number"}},"collection_type":"documents","primary_key":["userId"]}

Inserting 3 users
{ userId: 1, name: 'Jania McGrory', balance: 100 }
{ userId: 2, name: 'Amy Jackson', balance: 200 }
{ userId: 3, name: 'Amylia Jones', balance: 80 }

Read user with userId = 2
{ userId: 2, name: 'Amy Jackson', balance: 200 }

Reading all users
{ userId: 1, name: 'Jania McGrory', balance: 100 }
{ userId: 2, name: 'Amy Jackson', balance: 200 }
{ userId: 3, name: 'Amylia Jones', balance: 80 }

Update balance to 45 for name = Jania McGrory
Verify that update has processed
{ userId: 1, name: 'Jania McGrory', balance: 45 }

Find users with name like 'amy'
{ name: 'Amy Jackson', userId: 2, balance: 200 }
{ name: 'Amylia Jones', userId: 3, balance: 80 }

Delete userId = 3
Read all users to verify userId = 3 is deleted
{ userId: 1, name: 'Jania McGrory', balance: 45 }
{ userId: 2, name: 'Amy Jackson', balance: 200 }

Drop collection
DropCollectionResponse {
  _status: 'dropped',
  _message: 'collection dropped successfully'
}

Quickstart tutorial completed
```

Yay! we successfully executed our first few queries against Tigris database
using TypeScript.

### 6. Next steps

In this Quickstart guide, you have learnt how to get started with Tigris in
a TypeScript project. Feel free to dive deeper into the dedicated
[reference guide for TypeScript](typescript/index.mdx).
