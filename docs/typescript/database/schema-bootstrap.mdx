import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

# Automatic Schema Management

Made changes to your data models and forgot to apply them in production before deployment? Have
to communicate schema changes to others or wait for that project tracker issue to resolve? Unexpected
changes happen all the time, often by mistake and without warning. Even with change control policies
carved in stone, they may not always be followed.

Tigris lets you automate the schema management process completely and ensures that the data models
in your application are always in sync with the corresponding schema in the database. This makes the
change control as simple as a "Code review". Let's see how this works.

## How does this work?

Define your data models [using decorators](datamodel.mdx#declare-using-decorators) in your TypeScript project.
Register them with the Tigris client during build time and let the Tigris SDK automatically synchronize your
data models with the database. This includes creating collections that do not exist, as well as
applying schema changes if the data model has evolved.

For example, let's use following `Product` and `User` data model:

```ts title="models/tigris/product.ts"
import {
  TigrisCollectionType,
  TigrisCollection,
  TigrisDataTypes,
  PrimaryKey,
  Field,
} from "@tigrisdata/core";

export const PRODUCTS_COLLECTION_NAME = "products";

@TigrisCollection(PRODUCTS_COLLECTION_NAME)
export class Product implements TigrisCollectionType {
  @PrimaryKey(TigrisDataTypes.INT32, { order: 1, autoGenerate: true })
  id?: number;

  @Field()
  title: string;

  @Field()
  description: string;

  @Field()
  price: number;
}
```

```ts title="models/tigris/user.ts"
import {
  TigrisCollectionType,
  TigrisCollection,
  TigrisDataTypes,
  PrimaryKey,
  Field,
} from "@tigrisdata/core";

export const USERS_COLLECTION_NAME = "users";

export class Status {
  @Field(TigrisDataTypes.DATE_TIME)
  lastSeenAt: string;

  @Field(TigrisDataTypes.DATE_TIME)
  memberSince: string;
}

@TigrisCollection(USERS_COLLECTION_NAME)
export class User implements TigrisCollectionType {
  @PrimaryKey({ order: 1 })
  name: number;

  @Field()
  status: Status;
}
```

### Use this script to register models

Now, let's write a script that can trigger build time to automatically create or update the collections

```ts title="scripts/setup.ts"
import { Tigris } from "@tigrisdata/core";
import { Product } from "../models/product";
import { User } from "../models/user";

async function main() {
  const tigris = new Tigris({
    serverUrl: "api.preview.tigrisdata.cloud",
    clientId: "Your client_id here",
    clientSecret: "Your client_secret here",
    projectName: "Your project name here",
  });

  //highlight-start
  await tigris.registerSchemas([Product, User]);
  //highlight-end
}
```

### Execute setup script at build time

Include this script in `package.json` of your **npm** project and register triggers depending how your
project builds. Here are some examples for popular frameworks:

<Tabs>
<TabItem value="cli" label="CLI">

```shell
$> cd <project root>
$> npx ts-node scripts/setup.ts
```

</TabItem>

<TabItem value="nextjs" label="Next.js">

```json title="package.json"
{
  "scripts": {
    //highlight-start
    "setup": "npx ts-node scripts/setup.ts",
    "predev": "npm run setup",
    //highlight-end
    "dev": "next dev",
    "build": "next build",
    //highlight-start
    "postbuild": "npm run setup",
    //highlight-end
    "start": "next start"
  }
}
```

</TabItem>

<TabItem value="nuxtjs" label="NuxtJS">

```json title="package.json"
{
  "scripts": {
    //highlight-start
    "setup": "npx ts-node scripts/setup.ts",
    "predev": "npm run setup",
    //highlight-end
    "dev": "nuxt dev",
    "build": "nuxt build",
    //highlight-start
    "postbuild": "npm run setup",
    //highlight-end
    "start": "nuxt start"
  }
}
```

</TabItem>

<TabItem value="nestjs" label="NestJS">

```json title="package.json"
{
  "scripts": {
    //highlight-start
    "setup": "npx ts-node scripts/setup.ts",
    "predev": "npm run setup",
    //highlight-end
    "dev": "nest start --watch",
    "build": "nest build",
    //highlight-start
    "postbuild": "npm run setup"
    //highlight-end
    "start": "node dist/main"
  }
}
```

</TabItem>

<TabItem value="remix" label="Remix">

```json title="package.json"
{
  "scripts": {
    //highlight-start
    "setup": "npx ts-node scripts/setup.ts",
    "predev": "npm run setup",
    //highlight-end
    "dev": "remix dev",
    "build": "remix build",
    //highlight-start
    "postbuild": "npm run setup",
    //highlight-end
    "start": "remix-serve build"
  }
}
```

</TabItem>
</Tabs>

This way your data models are always synchronized with the database and you never have to step out of
your development workflow.

## FAQs

<details>
  <summary>Q - Will a new collection be created if it already exists?</summary>

- No, a new collection will not be created. However, Tigris will attempt to modify the existing
  schema if there are changes. [Learn more about schema modification in Tigris](schema.mdx#modifying-the-schema)

</details>

<details>
  <summary>Q - Will a collection be deleted if corresponding model is removed?</summary>

- No, that would be an unsafe operation. Users have to explicitly delete collection(s).

</details>

<details>
  <summary>Q - Is using Tigris schema manager required?</summary>

- No, this is just one convenient method to simplify your development workflow.

</details>
